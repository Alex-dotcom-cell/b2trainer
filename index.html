<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>B2 German Exam Trainer ‚Äî Chrome-Ready TTS</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React & ReactDOM (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel for JSX in-browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: #f8fafc; }
    .btn-icon { width: 2.25rem; height: 2.25rem; display: inline-flex; align-items:center; justify-content:center; border-radius: 9999px; }
    .card { background: white; border: 1px solid rgba(15,23,42,0.06); border-radius: 12px; padding: 1rem; box-shadow: 0 6px 20px rgba(2,6,23,0.04); }
    pre { white-space: pre-wrap; word-break: break-word; }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100%{ opacity:1 } 50%{ opacity:0.75 } }
  </style>
</head>
<body class="p-6">

  <div id="root" class="max-w-6xl mx-auto"></div>

  <script type="text/babel">
  const { useState, useEffect, useMemo, useCallback, useRef } = React;

  /* ========== CONFIG: ElevenLabs (Premium) ========== */
  // –¢–æ—Ç –∫–ª—é—á, —á—Ç–æ —Ç—ã —É–∂–µ –ø—Ä–æ–±–æ–≤–∞–ª ‚Äî –æ—Å—Ç–∞–≤–ª–µ–Ω –∑–¥–µ—Å—å –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞.
  // –ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å, –ø–æ–∑–∂–µ –≤—ã–Ω–µ—Å–µ–º –≤ Secrets –Ω–∞ GitHub.
  const ELEVEN = {
    API_KEY: "sk_d16c6996ff71066a5da550247033cec8d72ab9e8ac821c45",
    VOICE_ID: "21m00Tcm4TlvDq8ikWAM", // Rachel (–∂–µ–Ω—Å–∫–∏–π) ‚Äî –º–æ–∂–µ—à—å –ø–æ–º–µ–Ω—è—Ç—å
    BASE_URL: "https://api.elevenlabs.io/v1/text-to-speech"
  };

  /* ========== DATA (—Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ ‚Äî –≤—Å–µ –≤–∞–∂–Ω—ã–µ —Ñ—Ä–∞–∑—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã) ========== */
  const SCHREIBEN_TOPICS = [
    { id: 'produkt', ru: '1. –¢–æ–≤–∞—Ä (–¥–µ—Ñ–µ–∫—Ç)', de: 'der neue Staubsauger' },
    { id: 'service', ru: '2. –£—Å–ª—É–≥–∞ (–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ)', de: 'Ihr Internetanschluss' },
    { id: 'kurs', ru: '3. –ö—É—Ä—Å/–®–∫–æ–ª–∞ (–Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏)', de: 'der Deutsch B2-Kurs' },
    { id: 'reise', ru: '4. –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ/–û—Ç–µ–ª—å (–Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏)', de: 'das gebuchte Hotelzimmer' },
    { id: 'wohnung', ru: '5. –î–µ—Ñ–µ–∫—Ç –≤ –∫–≤–∞—Ä—Ç–∏—Ä–µ', de: 'die Heizungsanlage in meiner Wohnung' },
    { id: 'rechnung', ru: '6. –°—á–µ—Ç/–î–æ–≥–æ–≤–æ—Ä (–æ—à–∏–±–∫–∞)', de: 'meine letzte Rechnung' },
    { id: 'transport', ru: '7. –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç (–∑–∞–¥–µ—Ä–∂–∫–∞/–ø—Ä–æ–±–ª–µ–º–∞)', de: 'die Bahnverbindung nach Berlin' },
  ];

  const PHRASES_DATA = {
    greetings: [ { id: 101, text: "Sehr geehrte Damen und Herren,", ru: "–£–≤–∞–∂–∞–µ–º—ã–µ –¥–∞–º—ã –∏ –≥–æ—Å–ø–æ–¥–∞,", tip: "–§–æ—Ä–º–∞–ª—å–Ω–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ." } ],
    issue_intro: [
      { id: 201, text: "Ich schreibe Ihnen bez√ºglich [–æ–±—ä–µ–∫—Ç –∂–∞–ª–æ–±—ã].", ru: "–Ø –ø–∏—à—É –í–∞–º –ø–æ –ø–æ–≤–æ–¥—É [–æ–±—ä–µ–∫—Ç –∂–∞–ª–æ–±—ã].", tip: "–ü—Ä–µ–¥–ª–æ–≥ 'bez√ºglich' ‚Äî Genitiv." },
      { id: 202, text: "Ich beziehe mich auf unsere Bestellung/Vereinbarung vom [–î–∞—Ç–∞].", ru: "–Ø —Å—Å—ã–ª–∞—é—Å—å –Ω–∞ –Ω–∞—à –∑–∞–∫–∞–∑/–¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å –æ—Ç [–î–∞—Ç–∞].", tip: "sich beziehen auf + Akk." }
    ],
    main_problem: [
      { id: 301, text: "Leider muss ich Ihnen mitteilen, dass [–æ–±—ä–µ–∫—Ç –∂–∞–ª–æ–±—ã] nicht der Beschreibung entspricht.", ru: "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, [–æ–±—ä–µ–∫—Ç –∂–∞–ª–æ–±—ã] –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—é.", tip: "–ü—Ä–∏–¥–∞—Ç–æ—á–Ω–æ–µ —Å 'dass' ‚Äî –≥–ª–∞–≥–æ–ª –≤ –∫–æ–Ω—Ü–µ." },
      { id: 302, text: "Der Hauptgrund f√ºr meine Beschwerde ist, dass es M√§ngel gibt.", ru: "–ü—Ä–∏—á–∏–Ω–∞ –∂–∞–ª–æ–±—ã ‚Äî –Ω–∞–ª–∏—á–∏–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–æ–≤.", tip: "M√§ngel ‚Äî –º–Ω. —á–∏—Å–ª–æ." }
    ],
    problem_consequence: [
      { id: 401, text: "Aufgrund dieses Problems konnte ich meine Arbeit nicht wie geplant durchf√ºhren.", ru: "–ò–∑-–∑–∞ —ç—Ç–æ–π –ø—Ä–æ–±–ª–µ–º—ã —è –Ω–µ —Å–º–æ–≥ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ä–∞–±–æ—Ç—É –∫–∞–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–ª.", tip: "Aufgrund + Genitiv." },
      { id: 402, text: "Das hat bei mir zu gro√üem √Ñrger und Unannehmlichkeiten gef√ºhrt.", ru: "–≠—Ç–æ –ø—Ä–∏–≤–µ–ª–æ –∫ –±–æ–ª—å—à–∏–º –Ω–µ—É–¥–æ–±—Å—Ç–≤–∞–º.", tip: "–£—Å—Ç–æ–π—á–∏–≤—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è." }
    ],
    evidence: [
      { id: 501, text: "Ich habe Ihnen alle notwendigen Unterlagen in der Anlage beigef√ºgt.", ru: "–Ø –ø—Ä–∏–ª–æ–∂–∏–ª –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã.", tip: "beif√ºgen ‚Äî Perfekt: habe beigef√ºgt." },
      { id: 502, text: "Ich m√∂chte Sie bitten, die Angelegenheit innerhalb von 14 Tagen zu kl√§ren.", ru: "–ü—Ä–æ—à—É —Ä–µ—à–∏—Ç—å –≤–æ–ø—Ä–æ—Å –≤ —Ç–µ—á–µ–Ω–∏–µ 14 –¥–Ω–µ–π.", tip: "Infinitivkonstruktion mit 'zu'." }
    ],
    resolution_request: [
      { id: 601, text: "Daher bitte ich Sie h√∂flich um eine schnelle L√∂sung und um Ersatz.", ru: "–ü—Ä–æ—à—É —Å—Ä–æ—á–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è –∏ –∑–∞–º–µ–Ω—ã.", tip: "Daher ‚Äî —Å–ª–µ–¥—Å—Ç–≤–∏–µ." },
      { id: 602, text: "Falls dies nicht m√∂glich ist, erwarte ich die volle R√ºckerstattung des Kaufpreises.", ru: "–ï—Å–ª–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ ‚Äî –æ–∂–∏–¥–∞—é –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å—Ä–µ–¥—Å—Ç–≤.", tip: "Falls = –µ—Å–ª–∏." }
    ],
    closing_formula: [ { id: 701, text: "Ich danke Ihnen f√ºr Ihre M√ºhe und hoffe auf eine schnelle Kl√§rung.", ru: "–ë–ª–∞–≥–æ–¥–∞—Ä—é –∑–∞ –≤–Ω–∏–º–∞–Ω–∏–µ –∏ –Ω–∞–¥–µ—é—Å—å –Ω–∞ –±—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ.", tip: "–°–ø–∞—Å–∏–±–æ + –Ω–∞–¥–µ–∂–¥–∞." } ],
    sign_off: [ { id: 801, text: "Mit freundlichen Gr√º√üen,", ru: "–° —É–≤–∞–∂–µ–Ω–∏–µ–º,", tip: "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø–æ–¥–ø–∏—Å—å." } ],
  };

  const SPRECHEN_SCENARIOS = [
    {
      id: 'thema1',
      title_ru: '–¢–µ–º–∞ 1: –û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—è',
      title_de: 'Thema 1: Arbeitgeber beschreiben',
      dialogues: [
        {
          id: '1a',
          title_ru: 'A. –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–∞—è IT-–∫–æ–º–ø–∞–Ω–∏—è',
          text_de: `A: Ich m√∂chte √ºber einen Arbeitgeber sprechen, bei dem ich gerne arbeiten w√ºrde ‚Äì ein internationales IT-Unternehmen.
B: Klingt spannend. In welcher Branche ist das Unternehmen t√§tig?
A: Es entwickelt Softwarel√∂sungen f√ºr gro√üe Firmen, zum Beispiel f√ºr Banken und Versicherungen.`,
          text_ru: `A: –Ø —Ö–æ—á—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª–µ ‚Äî –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–π IT-–∫–æ–º–ø–∞–Ω–∏–∏.
B: –í –∫–∞–∫–æ–π –æ—Ç—Ä–∞—Å–ª–∏ –æ–Ω–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç?
A: –û–Ω–∞ —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ü–û –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π.`
        }
      ]
    }
  ];

  const initialActiveScenario = SPRECHEN_SCENARIOS[0];

  /* ========== UTILS: WebSpeech fallback ========== */
  function speakWithWebSpeech(text, lang = "de-DE") {
    return new Promise((resolve, reject) => {
      if (!("speechSynthesis" in window)) return reject(new Error("SpeechSynthesis not supported"));
      if (window.speechSynthesis.getVoices().length === 0) {
        // wait for voices to load
        window.speechSynthesis.addEventListener('voiceschanged', () => {
          speakWithWebSpeech(text, lang).then(resolve).catch(reject);
        }, { once: true });
        return;
      }
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = lang;
      u.rate = 0.9;
      u.onend = () => resolve();
      u.onerror = (e) => reject(e);
      const voices = window.speechSynthesis.getVoices();
      const german = voices.find(v => v.lang && v.lang.startsWith('de'));
      if (german) u.voice = german;
      window.speechSynthesis.speak(u);
    });
  }

  /* ========== TTS: ElevenLabs via fetch + AudioContext playback (Chrome-safe) ========== */

  // Simple cache for generated audio (Map: cacheKey -> objectURL)
  const ttsCache = new Map();

  // AudioContext singleton
  let audioCtx = null;
  function getAudioContext() {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    return audioCtx;
  }

  // Call ElevenLabs ‚Äî returns Blob or throws
  async function fetchElevenLabsAudio(text, voiceId = ELEVEN.VOICE_ID) {
    if (!ELEVEN.API_KEY) throw new Error("No ElevenLabs API key");
    const url = `${ELEVEN.BASE_URL}/${voiceId}`;
    // ElevenLabs API expects JSON like { text, model, voice_settings... } and returns audio/mpeg
    const body = {
      text,
      model_id: "eleven_multilingual_v2",
      voice_settings: { stability: 0.4, similarity_boost: 0.6 }
    };
    const res = await fetch(url, {
      method: "POST",
      headers: {
        "Accept": "audio/mpeg",
        "Content-Type": "application/json",
        "xi-api-key": ELEVEN.API_KEY
      },
      body: JSON.stringify(body)
    });
    if (!res.ok) {
      const txt = await res.text().catch(()=>"");
      throw new Error(`ElevenLabs API error ${res.status}: ${txt}`);
    }
    const blob = await res.blob();
    if (!blob || blob.size === 0) throw new Error("Empty audio blob from ElevenLabs");
    return blob;
  }

  // Decode audio blob via AudioContext and play (returns promise that resolves when playback started)
  async function playBlobWithAudioContext(blob) {
    const ctx = getAudioContext();
    const arr = await blob.arrayBuffer();
    // decodeAudioData returns AudioBuffer
    const audioBuffer = await ctx.decodeAudioData(arr.slice(0)); // slice to ensure transferable copy
    const src = ctx.createBufferSource();
    src.buffer = audioBuffer;
    const gain = ctx.createGain();
    gain.gain.value = 1.0;
    src.connect(gain).connect(ctx.destination);
    src.start(0);
    // resolve after a small delay once started
    return new Promise((resolve) => {
      src.onended = () => resolve();
      // Also resolve immediately so UI can release spinner; but keep src alive until end
      resolve();
    });
  }

  // High-level speak function:
  // 1) Try cache -> use cached objectURL and play via AudioContext decode
  // 2) Try ElevenLabs fetch -> decode & play, cache
  // 3) Fallback to WebSpeech
  async function speakPremium(text, onLog = ()=>{}) {
    if (!text || text.trim().length === 0) return;
    const cacheKey = `eleven:${text.slice(0,300)}`; // short key
    try {
      // 1) cache
      if (ttsCache.has(cacheKey)) {
        onLog("Using cached audio");
        const cachedUrl = ttsCache.get(cacheKey);
        // fetch cached blob by URL and play via audioContext (we can fetch then decode)
        const cachedResp = await fetch(cachedUrl);
        const cachedBlob = await cachedResp.blob();
        await playBlobWithAudioContext(cachedBlob);
        return { engine: "elevenlabs", cached: true };
      }

      // 2) request ElevenLabs
      onLog("Requesting ElevenLabs...");
      const blob = await fetchElevenLabsAudio(text);
      // create object URL for potential reuse
      const objUrl = URL.createObjectURL(blob);
      ttsCache.set(cacheKey, objUrl);
      onLog("Playing ElevenLabs audio (AudioContext)...");
      await playBlobWithAudioContext(blob);
      return { engine: "elevenlabs", cached: false };
    } catch (e) {
      onLog("ElevenLabs failed: " + (e.message || e));
      // 3) fallback
      try {
        await speakWithWebSpeech(text, "de-DE");
        return { engine: "webspeech" };
      } catch (wsErr) {
        onLog("WebSpeech also failed: " + (wsErr.message || wsErr));
        throw new Error("All TTS engines failed");
      }
    }
  }

  /* ========== Small UI icons ========== */
  const Icon = {
    Volume: (props) => (<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" strokeWidth="1.6" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M11 5L6 9H2v6h4l5 4V5z" /><path d="M19 5c.4 1.1.5 2.3.5 3.5s-.1 2.4-.5 3.5" /><path d="M15 9.5c.3.8.5 1.7.5 2.5s-.2 1.7-.5 2.5" /></svg>),
    Loader: (props) => (<svg viewBox="0 0 24 24" width="16" height="16" className="animate-spin" {...props}><circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="2" fill="none" strokeDasharray="31.4 31.4" strokeLinecap="round"></circle></svg>),
    Check: (props) => (<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M20 6L9 17l-5-5"/></svg>),
    Refresh: (props) => (<svg viewBox="0 0 24 24" width="16" height="16" {...props}><path d="M21 12a9 9 0 1 0-3.2 6.7L21 18" stroke="currentColor" strokeWidth="1.6" fill="none"/><path d="M21 12v6h-6" stroke="currentColor" strokeWidth="1.6" fill="none"/></svg>)
  };

  /* ========== React App ========== */
  function App(){
    const [view, setView] = useState('schreiben');
    const [selections, setSelections] = useState(useMemo(()=>({
      greetings: PHRASES_DATA.greetings[0].id,
      issue_intro: PHRASES_DATA.issue_intro[0].id,
      main_problem: PHRASES_DATA.main_problem[0].id,
      problem_consequence: PHRASES_DATA.problem_consequence[0].id,
      evidence: PHRASES_DATA.evidence[0].id,
      resolution_request: PHRASES_DATA.resolution_request[0].id,
      closing_formula: PHRASES_DATA.closing_formula[0].id,
      sign_off: PHRASES_DATA.sign_off[0].id,
    }),[]));
    const [activeTopic, setActiveTopic] = useState(SCHREIBEN_TOPICS[0]);
    const [senderName, setSenderName] = useState("Ivan Ivanov");
    const [invoiceNumber, setInvoiceNumber] = useState("RE-2024-5829");
    const [currentDate] = useState(new Date().toLocaleDateString('de-DE'));
    const [activeScenario, setActiveScenario] = useState(initialActiveScenario);
    const [activeDialogue, setActiveDialogue] = useState(initialActiveScenario.dialogues[0]);
    const [isLoading, setIsLoading] = useState(false);
    const [statusText, setStatusText] = useState("–ì–æ—Ç–æ–≤–æ");
    const [debug, setDebug] = useState([]);
    const [showDebug, setShowDebug] = useState(false);

    const allPhrases = useMemo(()=>Object.values(PHRASES_DATA).flat(), []);
    const findPhraseById = useCallback((id) => allPhrases.find(p=>p.id===id), [allPhrases]);
    const replacePlaceholder = useCallback((text)=>{
      if(!text) return '';
      return text.replace(/\[–æ–±—ä–µ–∫—Ç –∂–∞–ª–æ–±—ã\]/g, activeTopic.de).replace(/\[–î–∞—Ç–∞\]/g, currentDate);
    }, [activeTopic, currentDate]);

    const assembleLetterText = useCallback(()=>{
      const parts = [
        replacePlaceholder(findPhraseById(selections.greetings)?.text || ''),
        replacePlaceholder(findPhraseById(selections.issue_intro)?.text || ''),
        replacePlaceholder(findPhraseById(selections.main_problem)?.text || ''),
        replacePlaceholder(findPhraseById(selections.problem_consequence)?.text || ''),
        replacePlaceholder(findPhraseById(selections.evidence)?.text || ''),
        replacePlaceholder(findPhraseById(selections.resolution_request)?.text || ''),
        replacePlaceholder(findPhraseById(selections.closing_formula)?.text || ''),
        replacePlaceholder(findPhraseById(selections.sign_off)?.text || ''),
        senderName
      ];
      return parts.filter(Boolean).join("\n\n");
    }, [selections, findPhraseById, replacePlaceholder, senderName]);

    const log = useCallback((msg, type="info")=>{
      setDebug(prev => [...prev, {t: new Date().toLocaleTimeString(), m: msg, type}].slice(-30));
    }, []);

    // High-level speak wrapper ‚Äî ensures user gesture & shows status
    const speak = useCallback(async (text) => {
      try {
        setIsLoading(true);
        setStatusText("–ü—Ä–æ–±—É—é Premium TTS...");
        log("–ó–∞–ø—É—Å–∫ TTS –¥–ª—è —Ç–µ–∫—Å—Ç–∞: " + text.slice(0,40) + "...");
        const res = await speakPremium(text, (l)=>log(l));
        if (res && res.engine === "elevenlabs") setStatusText("–û–∑–≤—É—á–µ–Ω–æ: ElevenLabs");
        else if (res && res.engine === "webspeech") setStatusText("–û–∑–≤—É—á–µ–Ω–æ: Web Speech (fallback)");
        else setStatusText("–û–∑–≤—É—á–µ–Ω–æ");
      } catch (e) {
        setStatusText("–û—à–∏–±–∫–∞ TTS");
        log("–û—à–∏–±–∫–∞ TTS: " + (e.message || e), "error");
      } finally {
        setIsLoading(false);
      }
    }, [log]);

    // parse dialogs
    const parseDialogueLines = useCallback((deText, ruText) => {
      const deLines = (deText||"").split('\n').map(l=>l.trim()).filter(Boolean);
      const ruLines = (ruText||"").split('\n').map(l=>l.trim()).filter(Boolean);
      return deLines.map((de,i)=> {
        const speakerMatch = de.match(/^(A:|B:)/);
        const speaker = speakerMatch ? speakerMatch[0] : "A:";
        const de_text = de.replace(/^(A:|B:)\s*/, '');
        const ru_text = ruLines[i] ? ruLines[i].replace(/^(A:|B:)\s*/, '') : '';
        return { id: i, speaker, de_text, ru_text };
      });
    }, []);
    const parsedDialogue = useMemo(()=> parseDialogueLines(activeDialogue.text_de, activeDialogue.text_ru), [activeDialogue, parseDialogueLines]);

    // Quick test button handler
    const handleTestSound = async () => {
      // Must be called by user gesture (click) for Chrome autoplay policies
      const testText = "Hallo! Das ist ein Test des Premium-TTS. –ü—Ä–∏–≤–µ—Ç, —ç—Ç–æ —Ç–µ—Å—Ç –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ–π –æ–∑–≤—É—á–∫–∏.";
      await speak(testText);
    };

    // cleanup cache URLs when page unloads
    useEffect(() => {
      const onUnload = () => {
        ttsCache.forEach(url => {
          try { URL.revokeObjectURL(url); } catch(e){}
        });
      };
      window.addEventListener('beforeunload', onUnload);
      return () => window.removeEventListener('beforeunload', onUnload);
    }, []);

    return (
      <div className="space-y-6">
        <header className="text-center mb-4">
          <h1 className="text-3xl font-extrabold text-blue-800">B2 German Exam Trainer</h1>
          <p className="text-sm text-gray-600">Schreiben & Sprechen ‚Äî Pro style (Chrome-Ready TTS)</p>

          <div className="mt-3 flex items-center justify-center gap-3 flex-wrap">
            <button onClick={() => setView('schreiben')} className={`px-5 py-2 rounded-lg font-semibold ${view==='schreiben' ? 'bg-blue-700 text-white' : 'text-gray-700 hover:bg-gray-100'}`}>Schreiben</button>
            <button onClick={() => setView('sprechen')} className={`px-5 py-2 rounded-lg font-semibold ${view==='sprechen' ? 'bg-indigo-600 text-white' : 'text-gray-700 hover:bg-gray-100'}`}>Sprechen</button>

            <button onClick={handleTestSound} className="px-4 py-2 bg-purple-600 text-white rounded flex items-center">
              <svg width="16" height="16" className="mr-2" viewBox="0 0 24 24"><path d="M11 5L6 9H2v6h4l5 4V5z" stroke="currentColor" strokeWidth="1.6" fill="none"/><path d="M19 5c.4 1.1.5 2.3.5 3.5s-.1 2.4-.5 3.5" stroke="currentColor" strokeWidth="1.6" fill="none"/></svg>
              üéß –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–≤—É–∫
            </button>

            <button onClick={() => setShowDebug(s => !s)} className="px-3 py-2 border rounded text-sm">
              {showDebug ? "–°–∫—Ä—ã—Ç—å Debug" : "–ü–æ–∫–∞–∑–∞—Ç—å Debug"}
            </button>
          </div>

          <div className="mt-3 text-sm">
            <span className="inline-block px-3 py-1 rounded-full text-sm bg-gray-100">{isLoading ? "–ó–∞–≥—Ä—É–∑–∫–∞..." : statusText}</span>
          </div>
        </header>

        <main className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* LEFT column: Schreiben controls */}
          <div className="lg:col-span-1 space-y-4">
            <div className="card">
              <h3 className="text-lg font-semibold text-gray-800 mb-2">1. –í—ã–±–æ—Ä —Ç–µ–º—ã</h3>
              <select value={activeTopic.id} onChange={(e)=> setActiveTopic(SCHREIBEN_TOPICS.find(t=>t.id===e.target.value))} className="w-full p-3 rounded border">
                {SCHREIBEN_TOPICS.map(t=> <option key={t.id} value={t.id}>{t.ru} ‚Äî {t.de}</option>)}
              </select>

              <div className="mt-4">
                <label className="block text-sm text-gray-600">–í–∞—à–µ –ò–º—è</label>
                <input className="w-full p-2 mt-1 border rounded" value={senderName} onChange={e=>setSenderName(e.target.value)} />
              </div>

              <div className="mt-3">
                <label className="block text-sm text-gray-600">–ù–æ–º–µ—Ä —Å—á—ë—Ç–∞ / –∑–∞–∫–∞–∑–∞</label>
                <input className="w-full p-2 mt-1 border rounded" value={invoiceNumber} onChange={e=>setInvoiceNumber(e.target.value)} />
              </div>

              <div className="mt-4">
                <button onClick={()=>{
                  const newSel = Object.keys(PHRASES_DATA).reduce((acc,key)=>{
                    const items = PHRASES_DATA[key];
                    acc[key] = items[Math.floor(Math.random()*items.length)].id;
                    return acc;
                  },{});
                  setSelections(newSel);
                }} className="w-full bg-green-600 text-white py-2 rounded flex items-center justify-center">
                  <Icon.Refresh className="mr-2" /> –°–ª—É—á–∞–π–Ω–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è
                </button>
              </div>
            </div>

            <div className="card">
              <h3 className="text-lg font-semibold mb-2">2. –§—Ä–∞–∑—ã</h3>
              <div className="space-y-3 max-h-96 overflow-y-auto pr-2">
                {Object.keys(PHRASES_DATA).map(categoryKey=>{
                  const labels = {
                    greetings: '1. –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ',
                    issue_intro: '2. –í–≤–µ–¥–µ–Ω–∏–µ',
                    main_problem: '3. –°—É—Ç—å',
                    problem_consequence: '4. –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è',
                    evidence: '5. –î–æ–∫—É–º–µ–Ω—Ç—ã',
                    resolution_request: '6. –ó–∞–ø—Ä–æ—Å',
                    closing_formula: '7. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ',
                    sign_off: '8. –ü–æ–¥–ø–∏—Å—å'
                  };
                  return (
                    <div key={categoryKey} className="mb-3">
                      <div className="text-sm font-semibold text-gray-700 mb-2">{labels[categoryKey]}</div>
                      <div className="space-y-2">
                        {PHRASES_DATA[categoryKey].map(phrase=>{
                          const active = selections[categoryKey] === phrase.id;
                          return (
                            <div key={phrase.id} className={`p-3 rounded ${active ? 'bg-blue-50 border-2 border-blue-200' : 'bg-gray-50 border border-gray-100'} flex justify-between items-start`}>
                              <div>
                                <div className="font-medium">{replacePlaceholder(phrase.text)}</div>
                                <div className="text-sm text-gray-500 mt-1 italic">{phrase.ru}</div>
                              </div>
                              <div className="ml-3 flex flex-col items-end">
                                <button className="btn-icon bg-white border p-1 mb-2" title="–í—ã–±—Ä–∞—Ç—å" onClick={()=> setSelections(prev=>({...prev,[categoryKey]: phrase.id}))}>
                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.6"><path d="M20 6L9 17l-5-5"/></svg>
                                </button>
                                <button className="btn-icon bg-blue-600 text-white p-1" title="–û–∑–≤—É—á–∏—Ç—å" onClick={()=> speak(replacePlaceholder(phrase.text))}>
                                  {isLoading ? <Icon.Loader /> : <Icon.Volume />}
                                </button>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>

          {/* CENTER + RIGHT */}
          <div className="lg:col-span-2 space-y-6">
            <div className="card">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-bold text-gray-800">–ì–æ—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ</h2>
                <div className="text-sm text-gray-600">–î–∞—Ç–∞: {currentDate}</div>
              </div>

              <div className="bg-gray-50 p-4 rounded border border-gray-100 min-h-[220px] whitespace-pre-wrap text-gray-800">
                <pre className="m-0">{assembleLetterText()}</pre>
              </div>

              <div className="mt-4 flex gap-3 flex-wrap items-center">
                <button className="px-4 py-2 bg-blue-700 text-white rounded" onClick={()=> speak(assembleLetterText())}>
                  {isLoading ? <Icon.Loader className="mr-2" /> : <Icon.Volume className="mr-2" />} –û–∑–≤—É—á–∏—Ç—å –ø–∏—Å—å–º–æ
                </button>

                <button className="px-4 py-2 border rounded" onClick={()=> { navigator.clipboard.writeText(assembleLetterText()); alert("–ü–∏—Å—å–º–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ"); }}>
                  –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                </button>

                <a className="px-4 py-2 border rounded text-sm" href={"data:text/plain;charset=utf-8," + encodeURIComponent(assembleLetterText())} download="letter.txt">–°–∫–∞—á–∞—Ç—å .txt</a>
              </div>
            </div>

            <div className="card">
              <div className="flex justify-between items-center mb-3">
                <h3 className="text-lg font-semibold">{activeScenario.title_ru} ‚Äî {activeScenario.title_de}</h3>
                <select value={activeScenario.id} onChange={(e)=>{
                  const s = SPRECHEN_SCENARIOS.find(x=>x.id===e.target.value);
                  setActiveScenario(s); setActiveDialogue(s.dialogues[0]);
                }} className="p-2 border rounded">
                  {SPRECHEN_SCENARIOS.map(s=> <option key={s.id} value={s.id}>{s.title_ru}</option>)}
                </select>
              </div>

              <div className="mb-3">
                <div className="text-sm text-gray-700 mb-2">{activeDialogue.title_ru}</div>
                <div className="space-y-2 max-h-96 overflow-y-auto pr-2">
                  {parsedDialogue.map(line=>(
                    <div key={line.id} className={`p-3 rounded ${line.speaker==='A:' ? 'bg-blue-50 border-blue-100' : 'bg-gray-50 border-gray-100'} flex justify-between items-start`}>
                      <div>
                        <div className="font-semibold"><span className="mr-2">{line.speaker}</span>{line.de_text}</div>
                        <div className="text-sm italic text-gray-600 mt-1">{line.ru_text}</div>
                      </div>
                      <div className="ml-3">
                        <button className="btn-icon bg-indigo-600 text-white p-1" onClick={()=> speak(line.de_text)}>
                          {isLoading ? <Icon.Loader /> : <Icon.Volume />}
                        </button>
                      </div>
                    </div>
                  ))}
                </div>

                <div className="mt-4 text-sm text-gray-600">
                  üí° –ß–∏—Ç–∞–π —Ä–µ–ø–ª–∏–∫–∏ –≤—Å–ª—É—Ö, –ø–æ–≤—Ç–æ—Ä—è—è –∏–Ω—Ç–æ–Ω–∞—Ü–∏—é ‚Äî —ç—Ç–æ —Ç—Ä–µ–Ω–∏—Ä—É–µ—Ç –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –Ω–∞ —ç–∫–∑–∞–º–µ–Ω–µ.
                </div>
              </div>
            </div>

          </div>
        </main>

        {showDebug && (
          <div className="card mt-4">
            <h3 className="text-lg font-semibold mb-2">Debug</h3>
            <div className="text-xs text-gray-700 space-y-1 max-h-44 overflow-y-auto pr-2">
              {debug.length === 0 && <div className="text-gray-500">–õ–æ–≥ –ø—É—Å—Ç ‚Äî –Ω–∞–∂–º–∏ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–≤—É–∫¬ª</div>}
              {debug.map((d,i)=>(
                <div key={i} className={`text-sm ${d.type === "error" ? 'text-red-600' : d.type==="info" ? 'text-gray-700' : 'text-yellow-700'}`}>
                  <strong className="text-xs text-gray-400 mr-2">{d.t}</strong> {d.m}
                </div>
              ))}
            </div>
          </div>
        )}

        <footer className="text-center text-xs text-gray-500 mt-8">
          –°–¥–µ–ª–∞–Ω–æ —Å ‚ù§Ô∏è ‚Äî Chrome-Ready TTS (ElevenLabs ‚Üí AudioContext) + Web Speech fallback.
        </footer>
      </div>
    );
  }

  // Render
  ReactDOM.createRoot(document.getElementById('root')).render(<App/>);

  </script>
</body>
</html>
